<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Astro Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --header-bg: #F8CFAF;
    --accent: #6b4fe6;
    --me-bubble: #eefbe9;
    --them-bubble: #ffffff;
    --shadow: 0 10px 30px rgba(15,23,42,0.12);
    --card-radius: 18px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto;background:#efefef;}
  .host-wrap{height:100vh;display:flex;align-items:center;justify-content:center;padding:24px;box-sizing:border-box;}
  .chat-card{
    width:100%;
    max-width:420px;
    height:82vh;
    background:white;
    border-radius:var(--card-radius);
    box-shadow:var(--shadow);
    overflow:hidden;
    display:flex;
    flex-direction:column;
    border:1px solid rgba(15,23,42,0.04);
  }
  .chat-header{
    display:flex;align-items:center;gap:12px;
    padding:12px 14px;background:var(--header-bg);
  }
  .astro-avatar{width:44px;height:44px;border-radius:10px;object-fit:cover;}
  .header-info{display:flex;flex-direction:column;}
  .astro-name{font-weight:600;color:#222;}
  .astro-meta{font-size:12px;color:#333;opacity:0.9;display:flex;gap:4px;align-items:center;}
  .online-dot{width:9px;height:9px;background:#2ecc71;border-radius:50%;box-shadow:0 0 6px rgba(46,204,113,0.45);}
  .messages{
    flex:1;padding:16px;overflow-y:auto;display:flex;flex-direction:column;gap:10px;
    background:linear-gradient(180deg,#e5ddd5,#e3dacb);
  }
  .msg-row{display:flex;flex-direction:column;max-width:78%;}
  .msg{padding:10px 12px;border-radius:14px;font-size:14px;line-height:1.3;box-shadow:0 1px 1px rgba(0,0,0,0.04);}
  .msg.me{align-self:flex-end;background:var(--me-bubble);border-bottom-right-radius:6px;}
  .msg.them{align-self:flex-start;background:var(--them-bubble);border-bottom-left-radius:6px;}
  .meta-row{display:flex;gap:8px;align-items:center;margin-top:6px;font-size:12px;color:#556;}
  .time{opacity:0.7}
  .ticks{font-size:12px;color:#556}
  .typing{font-size:13px;color:#222;padding:6px 12px;border-radius:12px;background:rgba(255,255,255,0.7);width:max-content;margin-left:12px;display:flex;gap:6px;align-items:center;}
  .typing .dot{width:6px;height:6px;background:#444;border-radius:50%;animation:blink 1s infinite;}
  @keyframes blink{0%{opacity:0}50%{opacity:1}100%{opacity:0}}
  .input-wrap{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(0,0,0,0.05);background:white;}
  .input-box{flex:1;display:flex;align-items:center;gap:8px;background:#f6f7fb;padding:8px 10px;border-radius:999px;border:1px solid rgba(12,17,23,0.04);}
  .input-box input{border:0;background:transparent;outline:0;font-size:15px;width:100%}
  .btn{background:linear-gradient(90deg,#fb8b55,#f8cfa7);border-radius:999px;padding:9px 14px;border:0;color:#111;font-weight:600;cursor:pointer;}
  .icon-btn{background:transparent;border:0;padding:6px;cursor:pointer;font-size:18px}
  .emoji-pop{position:absolute;bottom:78px;right:18px;background:white;padding:8px;border-radius:12px;box-shadow:var(--shadow);display:flex;gap:8px;flex-wrap:wrap;width:220px}
</style>
</head>
<body>

<div class="host-wrap">
  <div class="chat-card">
    
    <div class="chat-header">
      <img id="astroAvatar" class="astro-avatar" src="" alt="">
      <div class="header-info">
        <div class="astro-name" id="astroName">Astrologer</div>
        <div class="astro-meta"><span class="online-dot"></span><span id="onlineText">Online</span></div>
      </div>
    </div>

    <div id="messages" class="messages"></div>

    <div id="typingIndicator" class="typing" style="display:none;">
      <div class="dot"></div><div class="dot"></div><div class="dot"></div>Typingâ€¦
    </div>

    <div class="input-wrap">
      <div class="input-box" style="position:relative">
        <button id="emojiBtn" class="icon-btn">ðŸ˜Š</button>
        <input id="textInput" placeholder="Type message...">
      </div>
      <button id="sendBtn" class="btn">Send</button>
    </div>

  </div>
</div>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>
<script>
/* ==============================
     ASTRO MAP (multi-astro ready)
============================== */
const ASTROS = {
  Gautam: {
    name: "Gautam",
    img: "https://via.placeholder.com/150?text=Astro",   // replace later
  },
  // add more like:
  // astro1: { name: "Rohit", img:"url" }
};

/* ==============================
     GET ASTRO KEY
============================== */
const params = new URLSearchParams(window.location.search);
let astroKey = params.get("astro") || "Gautam";

if(!ASTROS[astroKey]) astroKey = "Gautam";

/* Set UI */
document.getElementById("astroName").textContent = ASTROS[astroKey].name;
document.getElementById("astroAvatar").src = ASTROS[astroKey].img;

/* ==============================
     UNIQUE CUSTOMER ID
============================== */
function getUUID(){
  let u = localStorage.getItem("astro_user_uuid");
  if(!u){
    u = "u_" + Math.random().toString(36).slice(2,10);
    localStorage.setItem("astro_user_uuid", u);
  }
  return u;
}
const UUID = getUUID();

/* CHANNEL = session_astro_key_uuid */
const CHANNEL = `session_${astroKey}_${UUID}`;
const CONTROL = `astro_${astroKey}_control`;

/* ==============================
     INIT PUBNUB
============================== */
const pubnub = new PubNub({
  publishKey: "pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc",
  subscribeKey:"sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2",
  uuid: UUID
});

/* ==============================
     SEND JOIN EVENT
============================== */
pubnub.publish({
  channel: CONTROL,
  message: {
    type: "join",
    astro: astroKey,
    uuid: UUID,
    channel: CHANNEL,
    ts: Date.now()
  }
});

/* ON WINDOW CLOSE -> LEAVE EVENT */
window.addEventListener("beforeunload", () => {
  pubnub.publish({
    channel: CONTROL,
    message: {
      type: "leave",
      astro: astroKey,
      uuid: UUID,
      channel: CHANNEL,
      ts: Date.now()
    }
  });
});

/* ==============================
     SUBSCRIBE
============================== */
pubnub.subscribe({ channels: [CHANNEL] });

/* ==============================
     UI ELEMENTS
============================== */
const msgBox = document.getElementById("messages");
const textInput = document.getElementById("textInput");
const sendBtn = document.getElementById("sendBtn");
const typingIndicator = document.getElementById("typingIndicator");

/* ==============================
     RECEIVE MESSAGES
============================== */
pubnub.addListener({
  message: (e) => {
    const m = e.message;
    if(m.sender === UUID) return;
    appendMessage(m.text, "them", m.ts);
  },
  signal: (e) => {
    const m = e.message;
    if(m.type === "typing" && m.from !== UUID){
      typingIndicator.style.display = m.isTyping ? "flex" : "none";
    }
  }
});

/* ==============================
     SEND MESSAGE
============================== */
function sendMessage(){
  const text = textInput.value.trim();
  if(!text) return;

  const msg = {
    id: Date.now().toString(36),
    sender: UUID,
    text,
    ts: Date.now(),
    status: "sent"
  };

  appendMessage(text, "me", msg.ts);

  pubnub.publish({ channel: CHANNEL, message: msg });

  textInput.value = "";
  textInput.focus();
}

sendBtn.onclick = sendMessage;
textInput.addEventListener("keydown", e=>{
  if(e.key==="Enter") sendMessage();
});

/* ==============================
     TYPING INDICATOR
============================== */
let typingTimeout;
textInput.addEventListener("input", () => {
  pubnub.signal({
    channel: CHANNEL,
    message: { type:"typing", from:UUID, isTyping:true }
  });
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(()=>{
    pubnub.signal({
      channel: CHANNEL,
      message: { type:"typing", from:UUID, isTyping:false }
    });
  }, 1200);
});

/* ==============================
     RENDER MESSAGE
============================== */
function appendMessage(text, who, ts){
  const row = document.createElement("div");
  row.className = "msg-row";

  const b = document.createElement("div");
  b.className = "msg " + who;
  b.textContent = text;

  const meta = document.createElement("div");
  meta.className = "meta-row";

  const t = document.createElement("span");
  t.className = "time";
  t.textContent = new Date(ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});

  meta.appendChild(t);

  row.appendChild(b);
  row.appendChild(meta);

  msgBox.appendChild(row);
  msgBox.scrollTop = msgBox.scrollHeight;
}

/* ==============================
     EMOJI PICKER
============================== */
const emojiBtn = document.getElementById("emojiBtn");
let emojiPopup;

emojiBtn.onclick = ()=>{
  if(emojiPopup){
    emojiPopup.remove();
    emojiPopup = null;
    return;
  }
  emojiPopup = document.createElement("div");
  emojiPopup.className = "emoji-pop";

  ["ðŸ˜€","ðŸ˜ƒ","ðŸ˜Š","ðŸ˜","ðŸ™","âœ¨","ðŸŒ™","ðŸ”®","ðŸ’«","ðŸ‘"].forEach(e=>{
    const b = document.createElement("button");
    b.textContent = e;
    b.style.fontSize="20px";
    b.style.border="none";
    b.style.background="transparent";
    b.style.cursor="pointer";
    b.onclick = ()=>{
      textInput.value += e;
      emojiPopup.remove();
      emojiPopup = null;
      textInput.focus();
    };
    emojiPopup.appendChild(b);
  });

  document.body.appendChild(emojiPopup);
};
</script>
</body>
</html>

