<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Customer Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<!-- PubNub -->
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#f4f4f4;
  height:100vh;
  display:flex;
  flex-direction:column;
}
.header{
  background:#FFDE59;
  padding:12px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.chat{
  flex:1;
  padding:12px;
  overflow-y:auto;
}
.msg{
  padding:10px 12px;
  border-radius:12px;
  margin-bottom:8px;
  max-width:80%;
}
.me{background:#fff;margin-left:auto}
.astro{background:#e8f0ff}
.controls{
  display:flex;
  gap:8px;
  padding:10px;
  background:#fff;
}
.controls input{
  flex:1;
  padding:10px;
  border-radius:20px;
}
.controls button{
  padding:10px 16px;
  border-radius:20px;
  background:#FFDE59;
  border:none;
  font-weight:600;
}
</style>
</head>

<body>

<div class="header">
  <div>
    Customer Chat<br>
    ‚è±Ô∏è <span id="timer">--:--</span>
  </div>
  <button onclick="recharge()">Recharge ‚Çπ50</button>
</div>

<div id="chat" class="chat"></div>

<div class="controls">
  <input id="msg" placeholder="Type message‚Ä¶">
  <button onclick="send()">Send</button>
</div>

<script>
/* ---------------- FIREBASE INIT ---------------- */
firebase.initializeApp({
  apiKey: "AIzaSyBPOzL5ZoYd0NelkDNYk0LGBPDYVT2Tqew",
  authDomain: "connect-astro-e5309.firebaseapp.com",
  projectId: "connect-astro-e5309",
  storageBucket: "connect-astro-e5309.appspot.com",
  messagingSenderId: "19853749942",
  appId: "1:19853749942:web:9857d058fcaeda0ba90017"
});


const functions = firebase.functions();
const demoRecharge = functions.httpsCallable("demoRecharge");
const chatNow = functions.httpsCallable("chatNow");

/* ---------------- STATE ---------------- */
const customerId = "cust_" + Math.random().toString(36).slice(2,8);
const astrologerId = "Gautam";

let pubnub = null;
let sessionId = null;
let channel = null;
let timeLeft = 0;
let timerInterval = null;

/* ---------------- RECHARGE + START SESSION ---------------- */
async function recharge(){
  try {
    // 1Ô∏è‚É£ Add money
    await demoRecharge({ customerId, amount: 50 });

    // 2Ô∏è‚É£ Start / refresh session
    const res = await chatNow({ customerId, astrologerId });

    sessionId = res.data.sessionId;
    channel = res.data.channel;
    timeLeft = Number(res.data.remainingSeconds);

    if (!timeLeft || timeLeft <= 0) {
      alert("No time available");
      return;
    }

    if (!pubnub) initPubNub();

    startTimer(); // üî• FIXED

    console.log("Timer started with:", timeLeft);

  } catch (e) {
    console.error(e);
    alert("Recharge failed");
  }
}

/* ---------------- PUBNUB ---------------- */
function initPubNub(){
  pubnub = new PubNub({
    publishKey:"pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc",
    subscribeKey:"sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2",
    uuid: customerId
  });

  pubnub.subscribe({ channels:[channel] });

  pubnub.addListener({
    message:e=>{
      if(e.message.sender !== customerId){
        addMsg(e.message.text,"astro");
      }
    }
  });
}

/* ---------------- SEND MESSAGE ---------------- */
function send(){
  const t = msg.value.trim();
  if(!t) return;
  msg.value = "";
  addMsg(t,"me");

  pubnub.publish({
    channel,
    message:{
      sender: customerId,
      text: t
    }
  });
}

/* ---------------- UI ---------------- */
function addMsg(text,type){
  const d = document.createElement("div");
  d.className = "msg " + type;
  d.textContent = text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

/* ---------------- TIMER (FINAL FIX) ---------------- */
function startTimer(){
  clearInterval(timerInterval);

  updateTimer(); // üî• SHOW IMMEDIATELY

  timerInterval = setInterval(()=>{
    timeLeft--;

    if(timeLeft <= 0){
      clearInterval(timerInterval);
      timer.textContent = "00:00";
      alert("Session ended");
      return;
    }

    updateTimer();
  },1000);
}

function updateTimer(){
  const m = Math.floor(timeLeft / 60);
  const s = timeLeft % 60;

  timer.textContent =
    String(m).padStart(2,"0") + ":" +
    String(s).padStart(2,"0");
}
</script>

</body>
</html>




