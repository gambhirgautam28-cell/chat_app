<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Chat with Astrologer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f4f4f4;height:100vh;display:flex;flex-direction:column}
.header{background:#F8CFAF;padding:14px;font-weight:700;display:flex;justify-content:space-between}
.chat{flex:1;padding:12px;overflow:auto}
.msg{max-width:75%;padding:10px;border-radius:12px;margin-bottom:8px}
.me{background:#ffe0cc;margin-left:auto}
.them{background:#fff}
.controls{display:flex;padding:10px;gap:8px;background:#fff}
input{flex:1;padding:10px;border-radius:20px;border:1px solid #ccc}
button{padding:10px 16px;border-radius:20px;border:none;background:#F8CFAF;font-weight:700}
#detailsBox,#walletBox{padding:14px;background:#fff}
#detailsBox input{width:100%;padding:10px;margin-bottom:8px;border-radius:8px;border:1px solid #ccc}
.rechargeBtns button{margin:6px 6px 0 0}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <span>Astrologer Gautam</span>
  <span>‚è±Ô∏è <span id="timer">--:--</span> | üí∞ ‚Çπ<span id="wallet">0</span></span>
</div>

<!-- CUSTOMER DETAILS -->
<div id="detailsBox">
  <input id="cname" placeholder="Full Name">
  <input id="cdob" type="date">
  <input id="cbirth" placeholder="Birth Place">
  <button onclick="goToWallet()">Continue</button>
</div>

<!-- WALLET -->
<div id="walletBox" style="display:none">
  <strong>Recharge Wallet</strong>
  <p>Astrologer charges ‚Çπ<span id="price"></span>/minute<br>
     Minimum recharge: ‚Çπ<span id="minRecharge"></span></p>
  <div class="rechargeBtns">
    <button onclick="recharge(50)">‚Çπ50</button>
    <button onclick="recharge(100)">‚Çπ100</button>
    <button onclick="recharge(200)">‚Çπ200</button>
    <button onclick="recharge(500)">‚Çπ500</button>
  </div>
</div>

<!-- CHAT -->
<div id="chat" class="chat"></div>

<!-- INPUT -->
<div class="controls">
  <input id="msg" placeholder="Type message‚Ä¶">
  <button onclick="send()">Send</button>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const CHANNEL = "astro_gautam_chat";
const pricePerMinute = 10;

/* ---------------- PUBNUB ---------------- */
const pubnub = new PubNub({
  publishKey: "pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc",
  subscribeKey: "sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2",
  uuid: "customer_" + Math.random().toString(36).slice(2,6)
});

pubnub.subscribe({ channels:[CHANNEL] });
pubnub.addListener({
  message:e=>{
    if(e.message.sender===pubnub.getUUID()) return;
    add(e.message.text,"them");
  }
});

/* ---------------- STATE ---------------- */
let chatStarted=false;
let wallet=0;
let timeLeft=0;
let timerInterval=null;

/* ---------------- FLOW ---------------- */
price.textContent = pricePerMinute;
minRecharge.textContent = pricePerMinute * 5;

function goToWallet(){
  if(!cname.value||!cdob.value||!cbirth.value){
    alert("Fill all details");
    return;
  }
  detailsBox.style.display="none";
  walletBox.style.display="block";
}

function recharge(amount){
  if(amount < pricePerMinute*5){
    alert("Minimum recharge not met");
    return;
  }

  wallet += amount;
  walletBox.style.display="none";
  document.getElementById("wallet").textContent = wallet;

  systemMsg(
    `üßë Customer Details\nName: ${cname.value}\nDOB: ${cdob.value}\nBirth Place: ${cbirth.value}`
  );

  systemMsg(`üí∞ Wallet recharged: ‚Çπ${wallet}`);
  startChat();
}

function startChat(){
  chatStarted=true;
  timeLeft = Math.floor((wallet / pricePerMinute) * 60);
  startTimer();
}

/* ---------------- TIMER ---------------- */
function startTimer(){
  updateTimer();
  timerInterval=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      systemMsg("‚õî Chat ended");
      chatStarted=false;
      return;
    }

    if(timeLeft===60) systemMsg("‚ö†Ô∏è 1 minute remaining");
    if(timeLeft===30) systemMsg("‚ö†Ô∏è 30 seconds remaining");

    updateTimer();
  },1000);
}

function updateTimer(){
  const m=String(Math.floor(timeLeft/60)).padStart(2,'0');
  const s=String(timeLeft%60).padStart(2,'0');
  timer.textContent = m+":"+s;
}

/* ---------------- CHAT ---------------- */
function send(){
  if(!chatStarted){alert("Start chat first");return;}
  const text=msg.value.trim();
  if(!text)return;
  msg.value="";
  add(text,"me");

  pubnub.publish({
    channel:CHANNEL,
    message:{sender:pubnub.getUUID(),text}
  });
}

function systemMsg(text){
  pubnub.publish({
    channel:CHANNEL,
    message:{sender:"SYSTEM",text}
  });
}

function add(text,cls){
  const d=document.createElement("div");
  d.className="msg "+cls;
  d.textContent=text;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}
</script>

</body>
</html>



