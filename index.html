<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Customer Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f4f4f4;height:100vh;display:flex;flex-direction:column}
.header{background:#FFDE59;padding:12px}
.chat{flex:1;padding:12px;overflow:auto}
.msg{padding:10px;border-radius:10px;margin-bottom:6px;max-width:80%}
.me{background:#fff;margin-left:auto}
.astro{background:#e8f0ff}
.controls{display:flex;padding:10px;background:#fff}
input{flex:1;padding:10px;border-radius:20px}
button{padding:10px 16px;border-radius:20px;background:#FFDE59;border:none}
</style>
</head>

<body>

<div class="header">
  Customer Chat | ⏱ <span id="timer">--:--</span>
</div>

<div id="chat" class="chat"></div>

<div class="controls">
  <input id="msg" placeholder="Type message">
  <button onclick="send()">Send</button>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const firebaseConfig = {
  /* YOUR FIREBASE CONFIG */
};

firebase.initializeApp(firebaseConfig);
const functions = firebase.functions();
const chatNow = functions.httpsCallable("chatNow");
const sendMessageFn = functions.httpsCallable("sendMessage");

const customerId = "cust_" + Math.random().toString(36).slice(2,7);
const astrologerId = "Gautam";

/* ---------------- STATE ---------------- */
let pubnub, channel, sessionId;
let timeLeft = 0, timerInterval;

/* ---------------- START SESSION ---------------- */
(async function start() {
  const res = await chatNow({ customerId, astrologerId });
  sessionId = res.data.sessionId;
  channel = res.data.channel;
  timeLeft = res.data.remainingSeconds;

  initTimer();
  initPubNub();
})();

/* ---------------- PUBNUB ---------------- */
function initPubNub(){
  pubnub = new PubNub({
    publishKey:"pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc",
    subscribeKey:"sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2",
    uuid: customerId
  });

  pubnub.subscribe({ channels:[channel] });

  pubnub.addListener({
    message:e=>{
      const m=e.message;
      if(m.senderId===customerId) return;
      addMsg(m.text,"astro",m.ts);
    }
  });
}

/* ---------------- SEND ---------------- */
function send(){
  const text=msg.value.trim();
  if(!text) return;
  msg.value="";
  addMsg(text,"me",Date.now());

  pubnub.publish({
    channel,
    message:{ sessionId, senderId:customerId, text, ts:Date.now() }
  });

  sendMessageFn({ sessionId, senderId:customerId, text });
}

/* ---------------- UI ---------------- */
function addMsg(text,type,ts){
  const d=document.createElement("div");
  d.className="msg "+type;
  d.innerHTML=text+`<div style="font-size:11px">${new Date(ts).toLocaleTimeString()}</div>`;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* ---------------- TIMER ---------------- */
function initTimer(){
  updateTimer();
  timerInterval=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){
      clearInterval(timerInterval);
      addMsg("⛔ Session ended","astro",Date.now());
      return;
    }
    updateTimer();
  },1000);
}
function updateTimer(){
  timer.textContent =
    String(Math.floor(timeLeft/60)).padStart(2,"0")+":"+
    String(timeLeft%60).padStart(2,"0");
}
</script>

</body>
</html>






