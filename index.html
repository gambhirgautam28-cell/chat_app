<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Customer Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

<!-- PubNub -->
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:#f4f4f4;height:100vh;display:flex;flex-direction:column}
.header{background:#FFDE59;padding:12px;font-weight:600}
.chat{flex:1;padding:12px;overflow-y:auto}
.msg{padding:10px;border-radius:12px;margin-bottom:8px;max-width:80%}
.me{background:#fff;margin-left:auto}
.astro{background:#e8f0ff}
.controls{display:flex;gap:8px;padding:10px;background:#fff}
input{flex:1;padding:10px;border-radius:20px}
button{padding:10px 16px;border-radius:20px;background:#FFDE59;border:none}
</style>
</head>

<body>

<div class="header">
  Customer Chat ‚è± <span id="timer">--:--</span>
  <button onclick="recharge()">Recharge ‚Çπ50</button>
</div>

<div id="chat" class="chat"></div>

<div class="controls">
  <input id="msg" placeholder="Type message">
  <button onclick="send()">Send</button>
</div>

<script>
/* üî• FIREBASE INIT */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  projectId: "connect-astro-e5309"
});

const functions = firebase.functions();
const demoRecharge = functions.httpsCallable("demoRecharge");
const chatNow = functions.httpsCallable("chatNow");

/* STATE */
const customerId = "cust_" + Math.random().toString(36).slice(2,7);
const astrologerId = "Gautam";

let pubnub, sessionId, channel;
let timeLeft = 0, timerInterval;

/* RECHARGE */
async function recharge(){
  await demoRecharge({ customerId, amount: 50 });
  const res = await chatNow({ customerId, astrologerId });

  sessionId = res.data.sessionId;
  channel = res.data.channel;
  timeLeft = res.data.remainingSeconds;

  if (!pubnub) initPubNub();
  startTimer();
}

/* PUBNUB */
function initPubNub(){
  pubnub = new PubNub({
    publishKey:"pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc",
    subscribeKey:"sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2",
    uuid: customerId
  });

  pubnub.subscribe({ channels:[channel] });

  pubnub.addListener({
    message:e=>{
      if(e.message.sender!==customerId){
        addMsg(e.message.text,"astro");
      }
    }
  });
}

/* SEND */
function send(){
  const t=msg.value.trim(); if(!t)return;
  msg.value="";
  addMsg(t,"me");

  pubnub.publish({
    channel,
    message:{ sender:customerId, text:t }
  });
}

/* UI */
function addMsg(t,c){
  const d=document.createElement("div");
  d.className="msg "+c;
  d.textContent=t;
  chat.appendChild(d);
  chat.scrollTop=chat.scrollHeight;
}

/* TIMER */
function startTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    timeLeft--;
    timer.textContent =
      String(Math.floor(timeLeft/60)).padStart(2,"0")+":"+
      String(timeLeft%60).padStart(2,"0");
  },1000);
}
</script>

</body>
</html>






