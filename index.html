<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Astro Chat — Customer</title>
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--header:#F8CFAF;--me:#eefbe9;--them:#fff}
  html,body{height:100%;margin:0;font-family:Inter,system-ui; background:#f2f2f2}
  .wrap{height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;box-sizing:border-box}
  .card{width:100%;max-width:420px;height:82vh;background:white;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);overflow:hidden;display:flex;flex-direction:column}
  .head{display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--header)}
  .avatar{width:44px;height:44px;border-radius:10px;background:#eee}
  .name{font-weight:700}
  .messages{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:linear-gradient(180deg,#e5ddd5,#e3dacb)}
  .bubble{max-width:72%;padding:10px 12px;border-radius:12px}
  .bubble.me{align-self:flex-end;background:var(--me)}
  .bubble.them{align-self:flex-start;background:var(--them)}
  .meta{font-size:12px;color:#444;margin-top:6px}
  .composer{display:flex;gap:10px;padding:12px;border-top:1px solid rgba(0,0,0,.05);background:white}
  .input{flex:1;padding:10px;border-radius:999px;border:1px solid #eee;background:#fafafa}
  .send{padding:10px 14px;border-radius:999px;border:0;background:linear-gradient(90deg,#fb8b55,#f8cfa7);font-weight:700;cursor:pointer}
  .typing{font-size:13px;color:#222;padding:6px 12px;border-radius:12px;background:rgba(255,255,255,0.8);width:max-content;margin-left:12px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main">
      <div class="head">
        <div class="avatar" id="astroAvatar"></div>
        <div>
          <div class="name" id="astroName">Gautam</div>
          <div id="astroStatus" style="font-size:13px;color:#333;opacity:.9">Connecting...</div>
        </div>
      </div>

      <div id="messages" class="messages" aria-live="polite"><div class="meta" style="opacity:.9">No messages yet — start the chat.</div></div>

      <div id="typingIndicator" class="typing" style="display:none">Astrologer is typing…</div>

      <div class="composer">
        <input id="text" class="input" placeholder="Type a message..."/>
        <button id="send" class="send">Send</button>
      </div>
    </div>
  </div>

  <!-- PubNub SDK -->
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>
  <script>
  // ---------- CONFIG (use your keys)
  const PUB_KEY = "pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc";
  const SUB_KEY = "sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2";

  // ---------- ASTRO (multi-astro ready)
  const params = new URLSearchParams(location.search);
  let astroKey = params.get('astro') || 'Gautam';
  // (optional) map display names here
  const ASTROS = { Gautam: { name: "Gautam", img:"https://via.placeholder.com/120?text=Astro" } };
  const ASTRO = ASTROS[astroKey] || ASTROS['Gautam'];
  document.getElementById('astroName').textContent = ASTRO.name;
  document.getElementById('astroAvatar').style.backgroundImage = `url(${ASTRO.img})`;
  document.getElementById('astroAvatar').style.backgroundSize = 'cover';

  // ---------- USER UUID (persistent)
  function getUUID(){
    let id = localStorage.getItem('connect_astro_user_uuid');
    if(!id){ id = 'u_' + Math.random().toString(36).slice(2,9); localStorage.setItem('connect_astro_user_uuid', id); }
    return id;
  }
  const UUID = getUUID();

  // ---------- CHANNELS
  const SESSION = `session_${astroKey}_${UUID}`;           // customer-host channel
  const CONTROL = `astro_${astroKey}_control`;            // control channel for dashboard

  // ---------- Init PubNub
  const pubnub = new PubNub({ publishKey: PUB_KEY, subscribeKey: SUB_KEY, uuid: UUID });

  // publish JOIN to control channel so dashboard sees you
  function announceJoin(){
    pubnub.publish({
      channel: CONTROL,
      message: { type:'join', astro: astroKey, uuid: UUID, channel: SESSION, ts: Date.now() }
    });
  }
  function announceLeave(){
    pubnub.publish({
      channel: CONTROL,
      message: { type:'leave', astro: astroKey, uuid: UUID, channel: SESSION, ts: Date.now() }
    });
  }

  // subscribe
  pubnub.subscribe({ channels: [SESSION] });

  // receive real-time events (messages + signals)
  pubnub.addListener({
    message: (evt) => {
      const m = evt.message;
      // ignore own messages (customers already append locally)
      if(m.sender === UUID) return;
      appendMessage(m.text, 'them', m.ts);
    },
    signal: (evt) => {
      const m = evt.message;
      if(m.type === 'typing' && m.from !== UUID){
        document.getElementById('typingIndicator').style.display = m.isTyping ? 'block' : 'none';
      }
    }
  });

  // HISTORY: try to load last 50
  pubnub.history({ channel: SESSION, count: 50 }, (status, res) => {
    if(res && res.messages){
      document.getElementById('messages').innerHTML = '';
      res.messages.forEach(obj => {
        const entry = obj.entry;
        appendMessage(entry.text, entry.sender === UUID ? 'me' : 'them', entry.ts);
      });
      scrollBottom();
    }
  });

  // UI helpers
  const msgList = document.getElementById('messages');
  function appendMessage(text, who, ts=Date.now()){
    const row = document.createElement('div');
    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (who==='me'?'me':'them');
    bubble.textContent = text;
    const meta = document.createElement('div'); meta.className='meta';
    meta.textContent = new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    row.appendChild(bubble); row.appendChild(meta);
    msgList.appendChild(row); scrollBottom();
  }
  function scrollBottom(){ msgList.scrollTop = msgList.scrollHeight; }

  // send message
  const input = document.getElementById('text');
  const sendBtn = document.getElementById('send');
  function send(){
    const text = input.value.trim(); if(!text) return;
    const payload = { id: Date.now().toString(36), sender: UUID, text, ts: Date.now() };
    // publish to session channel
    pubnub.publish({ channel: SESSION, message: payload }, (st, res) => {
      // append locally (optimistic)
      appendMessage(text, 'me', payload.ts);
    });
    input.value = ''; input.focus();
  }
  sendBtn.addEventListener('click', send);
  input.addEventListener('keydown', e => { if(e.key==='Enter') send(); });

  // typing signal
  let _t;
  input.addEventListener('input', () => {
    pubnub.signal({ channel: SESSION, message: { type:'typing', from: UUID, isTyping:true }});
    clearTimeout(_t); _t = setTimeout(()=> {
      pubnub.signal({ channel: SESSION, message: { type:'typing', from: UUID, isTyping:false }});
    }, 900);
  });

  // announce join on load
  announceJoin();
  // announce leave on close
  window.addEventListener('beforeunload', announceLeave);
  // show astro online
  document.getElementById('astroStatus').textContent = 'Connecting...';
  // optionally we can subscribe to a small presence channel or control response to set Online/Offline
  pubnub.subscribe({ channels: [CONTROL] });
  pubnub.addListener({ message: (e)=> {
    const m = e.message;
    if(m && m.type==='present' && m.astro===astroKey){
      document.getElementById('astroStatus').textContent = m.online ? 'Online' : 'Offline';
    }
  }});
  </script>
  <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>

</body>
</html>

