<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Astro Chat â€” Customer</title>

<!-- Load PubNub FIRST (required before your JS runs) -->
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.7.2.0.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet"/>
<style>
  body{
    font-family: Inter, system-ui;
    background:#f1f2f7;
    margin:0;
    display:flex;
    justify-content:center;
    padding:40px 0;
  }
  .wrap{
    width:100%;
    max-width:480px;
    background:white;
    border-radius:18px;
    overflow:hidden;
    box-shadow:0 10px 40px rgba(0,0,0,0.08);
  }
  .head{
    background:#F8CFAF;
    padding:14px 18px;
    display:flex;
    align-items:center;
    gap:14px;
  }
  .avatar{
    width:40px;height:40px;border-radius:10px;
    background:#eee;
  }
  .name{
    font-size:17px;font-weight:700;
  }
  .status{
    font-size:12px;color:#333;opacity:0.8;
  }
  .messages{
    height:60vh;
    overflow-y:auto;
    padding:18px;
    background:linear-gradient(180deg,#e5ddd5,#e3d8cb);
  }
  .bubble{
    max-width:80%;
    padding:10px 14px;
    border-radius:14px;
    margin-bottom:10px;
    font-size:15px;
  }
  .me{
    background:#dfffd8;
    margin-left:auto;
  }
  .them{
    background:white;
    border:1px solid rgba(0,0,0,0.07);
  }
  .composer{
    display:flex;
    padding:14px;
    background:#fff;
    border-top:1px solid #eee;
  }
  input{
    flex:1;
    padding:10px 14px;
    border-radius:14px;
    border:1px solid #ccc;
    font-size:15px;
  }
  button{
    margin-left:12px;
    padding:10px 16px;
    border-radius:14px;
    border:none;
    background:#ff8b55;
    color:white;
    font-weight:700;
    cursor:pointer;
  }
  #typingIndicator{
    font-size:13px;color:#444;margin-bottom:6px;display:none;
  }
</style>
</head>

<body>

<div class="wrap">
  <div class="head">
      <div class="avatar"></div>
      <div>
          <div class="name" id="astroName">Gautam</div>
          <div class="status" id="astroStatus">Connecting...</div>
      </div>
  </div>

  <div id="messages" class="messages">
      <div id="typingIndicator">Astrologer is typing...</div>
  </div>

  <div class="composer">
      <input id="input" placeholder="Type a message..."/>
      <button id="send">Send</button>
  </div>
</div>


<script>
/* -------------------------------
    CONFIGURATION
------------------------------- */
const PUB_KEY   = "pub-c-a90a128a-4e77-4b6a-bbb3-59d0fb688ddc";
const SUB_KEY   = "sub-c-1b514e35-fab1-4baf-88f1-6b628ab7e9c2";

const astroKey  = new URLSearchParams(location.search).get("astro") || "Gautam";
document.getElementById("astroName").textContent = astroKey;

// Unique session for this customer
const SESSION = "session_" + astroKey + "_" + Date.now();

// Control channel (online/offline + typing)
const CONTROL = "control_" + astroKey;

/* -------------------------------
    INIT PUBNUB
------------------------------- */
const pubnub = new PubNub({
    publishKey:   PUB_KEY,
    subscribeKey: SUB_KEY,
    uuid: "customer_" + SESSION
});

/* -------------------------------
    UI HELPERS
------------------------------- */
const msgBox = document.getElementById("messages");

function addBubble(text, isMe){
  const div = document.createElement("div");
  div.className = "bubble " + (isMe ? "me" : "them");
  div.textContent = text;
  msgBox.appendChild(div);
  msgBox.scrollTop = msgBox.scrollHeight;
}

/* -------------------------------
    SEND MESSAGE
------------------------------- */
document.getElementById("send").onclick = sendMsg;
document.getElementById("input").addEventListener("keydown", e => {
  if(e.key === "Enter") sendMsg();
});

function sendMsg(){
  const txt = document.getElementById("input").value.trim();
  if(!txt) return;

  pubnub.publish({
    channel: SESSION,
    message: { type:"msg", from:"customer", text:txt }
  });

  addBubble(txt, true);
  document.getElementById("input").value = "";
}

/* -------------------------------
    RECEIVE MESSAGES
------------------------------- */
pubnub.addListener({
  message: e => {
    const m = e.message;
    if(m.type === "msg" && m.from === "astro"){
      addBubble(m.text, false);
    }
    if(m.type === "typing"){
      document.getElementById("typingIndicator").style.display =
        m.isTyping ? "block" : "none";
    }
    if(m.type === "present"){
      document.getElementById("astroStatus").textContent =
        m.online ? "Online" : "Offline";
    }
  }
});

/* -------------------------------
    SUBSCRIBE
------------------------------- */
pubnub.subscribe({
  channels: [SESSION, CONTROL]
});

/* -------------------------------
    TYPING INDICATOR
------------------------------- */
let t;
document.getElementById("input").addEventListener("input", () => {
  pubnub.publish({
    channel: SESSION,
    message: { type:"typing", isTyping:true }
  });

  clearTimeout(t);
  t = setTimeout(() => {
    pubnub.publish({
      channel: SESSION,
      message: { type:"typing", isTyping:false }
    });
  }, 900);
});

/* -------------------------------
    ANNOUNCE CUSTOMER JOIN
------------------------------- */
pubnub.publish({
  channel: CONTROL,
  message: { type:"present", astro:astroKey, online:true }
});

/* -------------------------------
    ANNOUNCE LEAVE
------------------------------- */
window.addEventListener("beforeunload", () => {
  pubnub.publish({
    channel: CONTROL,
    message: { type:"present", astro:astroKey, online:false }
  });
});
</script>

</body>
</html>

